
@model E_voting_System.Models.ListViewModel
@{
    ViewBag.Title = "Lists";
}
@{

    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<divclass ="container my-4">
    <h2 class="text-center mb-4">القوائم المحلية والحزبية</h2>
    <!-- Search Bar -->
    <div class="row mb-4">
        <div class="col-md-6 offset-md-3">
            <input type="text" id="listSearchInput" class="form-control" placeholder="ابحث عن قائمة..." onkeyup="filterLists()">
        </div>
    </div>
    <!-- Local Lists -->
    <h3>القوائم المحلية</h3>
    <div class="row">
        @foreach (var localList in Model.LocalLists)
        {
            <div class="col-md-4 mb-4 list-card" data-list-name="@localList.list_Name">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        @localList.list_Name
                    </div>
                    <div class="card-body">
                        @if (localList.Circle_ID == 1)
                        {
                            <p>دائرة اربد الاولى</p>
                        }
                        @if (localList.Circle_ID == 2)
                        {
                            <p>دائرة اربد الثانية</p>
                        }
                        @if (localList.Circle_ID == 3)
                        {
                            <p>دائرة جرش</p>
                        }

                        @if (!string.IsNullOrEmpty(localList.List_Logo))
                        {
                            <img src="@Url.Content("~/Content/Uploads/" + localList.List_Logo)" alt="Local List Image" class="img-fluid" />


                        }
                        <h5>المرشحين</h5>
                        <ul class="list-unstyled">
                            @if (Model.CandidatesByList.ContainsKey(localList.ID))
                            {
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>الرقم الوطني</th>
                                                <th>الاسم</th>
                                                <th>نوع الكرسي</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var candidate in Model.CandidatesByList[localList.ID])
                                            {
                                                <tr>
                                                    <td>@candidate.National_ID</td>
                                                    <td>@candidate.Candidate_Name</td>
                                                    <td>@candidate.Type_Of_Chair</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <p class="text-center text-muted">لا يوجد مرشحين</p>
                            }
                    </div>
                    <div class="card-footer text-center">
                        <div id="localListActions_@localList.ID">
                            @if (localList.Status == "Approved" || localList.Status == "Rejected")
                            {
                                <span class="status-text">@localList.Status</span>
                            }
                            else
                            {
                                <button class="btn btn-success" type="submit" onclick="showApprovalAlert(@localList.ID)">Approve</button>
                                <button class="btn btn-danger" onclick="showRejectionAlert(@localList.ID)">Decline</button>
                            }
                        </div>
                    </div>
                </div>
            </div>

        }
    </div>
    <!-- Party Lists -->
    <h3>القوائم الحزبية</h3>
    <div class="row">
        @foreach (var partyList in Model.PartyLists)
        {
            <div class="col-md-4 mb-4 list-card" data-list-name="@partyList.Party_Name">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        @partyList.Party_Name
                    </div>
                    <div class="card-body">
                        <p>Circle ID: @partyList.List_Name</p>
                        @if (!string.IsNullOrEmpty(partyList.List_Logo))
                        {

                            <img src="@Url.Content("~/Content/Uploads/" + partyList.List_Logo)" alt="Local List Image" class="img-fluid" />

                        }
                        <h5 class="mb-3">المرشحين</h5>

                        @if (Model.PartyCandidatesByList.ContainsKey(partyList.ID))
                        {<div class="table-responsive">
                                <table class="table table-bordered table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>الرقم الوطني</th>
                                            <th>الاسم</th>
                                            <th>الجنس</th>
                                            <th>الدين</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var candidate in Model.PartyCandidatesByList[partyList.ID])
                                        {
                                            <tr>
                                                <td>@candidate.National_ID</td>
                                                <td>@candidate.Name</td>
                                                <td>@candidate.Gender</td>
                                                <td>@candidate.Religion</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-center text-muted">لا يوجد مرشحين</p>

                        }
                    </div>

                    <div class="card-footer text-center">

                        <div id="partyListActions_@partyList.ID">
                            @if (partyList.Status == "Approved" || partyList.Status == "Rejected")
                            {
                                <span class="status-text">@partyList.Status</span>
                            }
                            else
                            {
                                <button class="btn btn-success" onclick="showApprovalAlert(@partyList.ID)">Approve</button>
                                <button class="btn btn-danger" onclick="showRejectionAlert(@partyList.ID)">Decline</button>
                            }
                        </div>
                    </div>
                </div>
            </div>

        }
    </div>

    <style>
        .list-card {
            transition: transform 0.2s ease-in-out;
        }

            .list-card:hover {
                transform: translateY(-5px);
            }
    </style>

    <script>
        function filterLists() {
            const searchInput = document.getElementById('listSearchInput').value.toLowerCase();
            const listCards = document.querySelectorAll('.list-card');

            listCards.forEach(card => {
                const listName = card.getAttribute('data-list-name').toLowerCase();
                if (listName.includes(searchInput)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function showApprovalAlert(listId) {
            Swal.fire({
                title: 'Approve this item?',
                input: 'textarea',
                inputLabel: 'Your message',
                inputPlaceholder: 'Type your message here...',
                showCancelButton: true,
                confirmButtonText: 'Approve',
                cancelButtonText: 'Cancel',
                preConfirm: (message) => {
                    return fetch(`/Admin/Approve`, {
                        method: 'POST',
                        body: JSON.stringify({ listId: listId, message: message }),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => {
                        if (!response.ok) {
                            throw new Error(response.statusText);
                        }
                        return response.json();
                    }).then(data => {
                        if (data.success) {
                            Swal.fire('Approved!', '', 'success');
                            document.getElementById(`localListActions_${listId}`).innerHTML = '<span class="status-text">Approved</span>';
                        } else {
                            Swal.fire('Failed!', data.message || 'Error occurred', 'error');
                        }
                    }).catch(error => {
                        Swal.fire('Error', error.message, 'error');
                    });
                }
            });
        }

        function showRejectionAlert(listId) {
            Swal.fire({
                title: 'Reject this item?',
                input: 'textarea',
                inputLabel: 'Your message',
                inputPlaceholder: 'Type your message here...',
                showCancelButton: true,
                confirmButtonText: 'Reject',
                cancelButtonText: 'Cancel',
                preConfirm: (message) => {
                    return fetch(`/Admin/Reject`, {
                        method: 'POST',
                        body: JSON.stringify({ listId: listId, message: message }),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => {
                        if (!response.ok) {
                            throw new Error(response.statusText);
                        }
                        return response.json();
                    }).then(data => {
                        if (data.success) {
                            Swal.fire('Rejected!', '', 'success');
                            document.getElementById(`localListActions_${listId}`).innerHTML = '<span class="status-text">Rejected</span>';
                        } else {
                            Swal.fire('Failed!', data.message || 'Error occurred', 'error');
                        }
                    }).catch(error => {
                        Swal.fire('Error', error.message, 'error');
                    });
                }
            });
        }
    </script>
